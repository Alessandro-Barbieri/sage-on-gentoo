--- src/DoConfig.orig	2009-08-15 00:53:11.000000000 +1200
+++ src/DoConfig	2010-02-20 23:13:04.392223845 +1300
@@ -25,14 +25,16 @@
 'LDFLAGS_CXX' => '$(LDFLAGS)',
 'LDLIBS'      => '-lm',
 'LDLIBS_CXX'  => '$(LDLIBS)',
+'PICFLAG'     => '-fPIC',
 'CPPFLAGS'    => '',
 
-'DEF_PREFIX'  => '/usr/local',
+'DEF_PREFIX'  => '/usr',
 
 'PREFIX'      => '$(DEF_PREFIX)',
 'LIBDIR'      => '$(PREFIX)/lib',
 'INCLUDEDIR'  => '$(PREFIX)/include',
 'DOCDIR'      => '$(PREFIX)/share/doc',
+'SHMAKE'      => 'non-gld',
 
 'GMP_PREFIX'  => '$(DEF_PREFIX)',
 'GMP_INCDIR'  => '$(GMP_PREFIX)/include',
@@ -55,6 +57,7 @@
 'NTL_PSTD_NTN'          => 'off',
 'NTL_GMP_LIP'           => 'off',
 'NTL_GMP_HACK'          => 'off',
+'NTL_MPIR'              => 'off',
 'NTL_GF2X_LIB'          => 'off',
 'NTL_CXX_ONLY'          => 'off',
 'NTL_X86_FIX'           => 'off',
@@ -90,11 +93,6 @@
 
 foreach $arg (@ARGV) {
 
-   if ($arg =~ '-h|help|-help|--help') {
-      system("more ../doc/config.txt");
-      exit;
-   }
-
    if (($name, $val) = ($arg =~ /(.*?)=(.*)/)) {
 
       $Variable{$name} = 0;
@@ -148,9 +146,15 @@
 $MakeVal{'GMPI'} = '# ';
 $MakeVal{'GMPL'} = '# ';
 $MakeVal{'GMP'} =  '# ';
+$MakeVal{'MPIR'} = '# ';
 
 if ($ConfigFlag{'NTL_GMP_LIP'} eq 'on' || $ConfigFlag{'NTL_GMP_HACK'} eq 'on') {
-   $MakeVal{'GMP'} = '';
+   if ($ConfigFlag{'NTL_MPIR'} eq 'on') {
+      $MakeVal{'MPIR'} = '';
+   }
+   else {
+      $MakeVal{'GMP'} = '';
+   }
    if (exists($Variable{'DEF_PREFIX'}) ||
        exists($Variable{'GMP_PREFIX'}) ||
        exists($Variable{'GMP_INCDIR'})) {
--- src/mfile.orig	2010-02-20 23:01:32.868223659 +1300
+++ src/mfile	2010-02-20 23:17:28.612223982 +1300
@@ -103,6 +103,7 @@
 GMP_OPT_INCDIR=@{GMPI}-I$(GMP_INCDIR) # GMPI
 GMP_OPT_LIBDIR=@{GMPL}-L$(GMP_LIBDIR) # GMPL
 GMP_OPT_LIB=@{GMP}-lgmp # GMP
+GMP_OPT_LIB=@{MPIR}-lmpir # MPIR
 # uncomment these if using GMP
 
 
@@ -141,6 +142,16 @@
 WIZARD=@{WIZARD}
 # Set to off if you want to bypass the wizard; otherwise, set to on.
 
+###############################################################
+#
+# New addition for shared library building. With gcc you need to
+# choose the Position Indepent Code flag. You have a choice of 
+# -fpic better code but in rare case not available (ppc)
+# -fPIC slightly slower code but guaranted to work anywhere.
+#
+###############################################################
+
+PICFLAG=@{PICFLAG}
 
 #################################################################
 #
@@ -173,6 +184,8 @@
 
 OBJ=$(O19)
 
+SHOBJ=$(subst .o,.lo,$(OBJ))
+
 # library source files
 
 
@@ -320,7 +333,7 @@
 LINK = $(CC) $(NTL_INCLUDE) $(CPPFLAGS) $(CFLAGS) $(LDFLAGS)
 LINK_CXX = $(CXX) $(NTL_INCLUDE) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS_CXX)
 
-
+.SUFFIXES: .lo
 
 # 'make all' does a complete make, including all setup.
 # It also creates the file 'all', which means you should
@@ -328,11 +341,11 @@
 # again.
 
 all:
-	make setup1
-	make setup2
-	make setup3
-	make setup4
-	make ntl.a
+	$(MAKE) setup1
+	$(MAKE) setup2
+	$(MAKE) setup3
+	$(MAKE) setup4
+	$(MAKE) ntl.a
 	touch all
 
 
@@ -378,18 +391,31 @@
 lip.o:	lip.c g_lip_impl.h c_lip_impl.h lip_gmp_aux_impl.h
 	$(LCOMP) $(COMPILE) $(GMP_OPT_INCDIR) lip.c
 
+lip.lo: lip.c g_lip_impl.h c_lip_impl.h lip_gmp_aux_impl.h
+	$(LCOMP) $(COMPILE) $(PICFLAG) $(GMP_INCDIR) lip.c -o lip.lo
+
+
+
 ctools.o:	ctools.c
 	$(LCOMP) $(COMPILE) ctools.c
 
+ctools.lo: 	 ctools.c
+	$(LCOMP) $(COMPILE) $(PICFLAG) ctools.c -o ctools.lo
+
 
 GetTime.o: GetTime.c 
 	$(LCOMP) $(COMPILE) GetTime.c
 
-
+GetTime.lo: GetTime.c 
+	$(LCOMP) $(COMPILE) $(PICFLAG) GetTime.c -o GetTime.lo
 
 .c.o: 
 	$(LCOMP) $(COMPILE_CXX) $(GF2X_OPT_INCDIR) $<
 
+.c.lo: 
+	$(LCOMP) $(COMPILE_CXX) $(PICFLAG) $(GF2X_OPT_INCDIR) -o $@ $<
+
+
 .c: 
 @{LSTAT}	$(LINK_CXX) -o $@ $< ntl.a $(GMP_OPT_LIBDIR) $(GMP_OPT_LIB) $(GF2X_OPT_LIBDIR) $(GF2X_OPT_LIB) $(LDLIBS_CXX) #LSTAT
 @{LSHAR}	$(LIBTOOL) --mode=link $(LINK_CXX) -o $@ $< libntl.la #LSHAR
@@ -403,7 +429,7 @@
 
 check:
 	sh RemoveProg $(PROGS)
-	make QuickTest
+	$(MAKE) QuickTest
 	./QuickTest
 	sh RemoveProg QuickTest
 	sh TestScript
@@ -460,19 +486,18 @@
 #
 #################################################################
 
-clobber:	
+clobber:	clean
 	rm -f ntl.a mach_desc.h ../include/NTL/mach_desc.h  GetTime.c 
 	rm -f lip_gmp_aux_impl.h ../include/NTL/gmp_aux.h
-	sh RemoveProg $(PROGS) MakeDesc TestGetTime gen_lip_gmp_aux gen_gmp_aux
-	rm -f *.o
-	rm -rf small
+	sh RemoveProg $(PROGS)
+	rm -f libntl*.so*
 	rm -f cfileout mfileout
 	rm -rf .libs *.lo libntl.la
 	rm -f all
 
 clean:
 	sh RemoveProg MakeDesc TestGetTime gen_lip_gmp_aux gen_gmp_aux
-	rm -f *.o 
+	rm -f *.o  *.lo
 	rm -rf small
 @{LSHAR}	- $(LIBTOOL) --mode=clean rm -f libntl.la *.lo #LSHAR
 
@@ -549,3 +574,6 @@
 
 
 
+shared: DIRNAME $(SHOBJ)
+	 $(LINK_CXX) $(PICFLAG) -shared -Wl,-soname,lib`cat DIRNAME`.so -o lib`cat DIRNAME`.so $(SHOBJ) $(GMP_OPT_LIBDIR) $(GMP_OPT_LIB) $(GF2X_OPT_LIBDIR) $(GF2X_OPT_LIB)
+	 ln -s lib`cat DIRNAME`.so libntl.so
--- src/c_lip_impl.h.orig	2010-02-20 23:02:31.440224241 +1300
+++ src/c_lip_impl.h	2010-02-20 23:19:14.425223330 +1300
@@ -51,9 +51,11 @@
 
 int _ntl_gmp_hack = 1;
 
-
+#ifdef NTL_MPIR
+#include <mpir.h>
+#else
 #include <gmp.h>
-
+#endif
 
 static mp_limb_t *gspace_data = 0;
 static long gspace_size = 0;
--- src/g_lip_impl.h.orig	2010-02-20 23:02:39.598223907 +1300
+++ src/g_lip_impl.h	2010-02-20 23:19:30.814223485 +1300
@@ -35,7 +35,11 @@
 #include <math.h>
 
 
+#ifdef NTL_MPIR
+#include <mpir.h>
+#else
 #include <gmp.h>
+#endif
 
 typedef mp_limb_t *_ntl_limb_t_ptr;
 
--- src/gen_gmp_aux.c.orig	2010-02-20 23:02:54.864223233 +1300
+++ src/gen_gmp_aux.c	2010-02-20 23:20:08.828223551 +1300
@@ -21,7 +21,11 @@
 #else
 
 
+#ifdef NTL_MPIR
+#include <mpir.h>
+#else
 #include <gmp.h>
+#endif
 #include <NTL/mach_desc.h>
 
 void print2k(FILE *f, long k, long bpl)
--- src/gen_lip_gmp_aux.c.orig	2010-02-20 23:03:09.041223834 +1300
+++ src/gen_lip_gmp_aux.c	2010-02-20 23:19:43.088223147 +1300
@@ -8,7 +8,11 @@
 
 #ifdef NTL_GMP_HACK
 
+#ifdef NTL_MPIR
+#include <mpir.h>
+#else
 #include <gmp.h>
+#endif
 #include <NTL/mach_desc.h>
 
 
