# HG changeset patch
# User Nils Bruin <nbruin@sfu.ca>
# Date 1297666400 28800
# Node ID e173f4a68672f4b28a2435a5e26c401e3b92b065
# Parent  2aa53d20ef6082fac0ec6218b29a469ea7cf13ae
Better formatting of error messages thrown when Maxima throws an error

diff -r 2aa53d20ef60 -r e173f4a68672 sage/interfaces/maxima_lib.py
--- sage/interfaces/maxima_lib.py	Mon Feb 08 21:31:35 2010 -0800
+++ sage/interfaces/maxima_lib.py	Sun Feb 13 22:53:20 2011 -0800
@@ -488,7 +488,39 @@
 ecl_eval("(set-locale-subdir)")
 ecl_eval("(set-pathnames)")
 ecl_eval("(defun add-lineinfo (x) x)")
-ecl_eval("""(defun retrieve (msg flag &aux (print? nil))(error (concatenate 'string "Maxima asks:" (meval (list '($string) msg)))))""")
+#the following is a direct adaption of the definition of "retrieve" in the Maxima file
+#macsys.lisp. This routine is normally responsible for displaying a question and
+#returning the answer. We change it to throw an error in which the text of the question
+#is included. We do this by running exactly the same code as in the original definition
+#of "retrieve", but with *standard-output* redirected to a string.
+ecl_eval(r"""
+(defun retrieve (msg flag &aux (print? nil))
+  (declare (special msg flag print?))
+  (or (eq flag 'noprint) (setq print? t))
+  (error (concatenate 'string "Maxima asks:" (with-output-to-string (*standard-output*)
+      (terpri)
+      (cond ((not print?)
+	     (setq print? t)
+	     (princ *prompt-prefix*)
+	     (princ *prompt-suffix*))
+	    ((null msg)
+	     (princ *prompt-prefix*)
+	     (princ *prompt-suffix*))
+	    ((atom msg)
+	     (format t "~a~a~a" *prompt-prefix* msg *prompt-suffix*)
+	     (mterpri))
+	    ((eq flag t)
+	     (princ *prompt-prefix*)
+	     (mapc #'princ (cdr msg))
+	     (princ *prompt-suffix*)
+	     (mterpri))
+	    (t
+	     (princ *prompt-prefix*)
+	     (displa msg)
+	     (princ *prompt-suffix*)
+	     (mterpri)))))))
+""")
+
 ecl_eval('(defparameter *dev-null* (make-two-way-stream (make-concatenated-stream) (make-broadcast-stream)))')
 ecl_eval('(defun principal nil (error "Divergent Integral"))')
 
